{%- liquid
  assign tip_title = block.settings.title | default: 'Mach deinen Look perfekt'
  assign tip_description = block.settings.description | default: '<p>Runde deinen Style ab mit dem passenden Schmuckstück. Gemeinsam strahlen sie noch mehr.</p>'
  assign mobile_bg_color = block.settings.mobile_background_color | default: '#f8f1f4'
  assign desktop_bg_color = block.settings.desktop_background_color | default: '#f8f1f4'

  assign product_tip = product.metafields.custom.product_tip.value
  if product_tip
    assign product_tip_product = product_tip.product.value
  endif
-%}

{%- if product_tip != blank and product_tip_product != blank -%}
  <div class="product__tip" {{ block.shopify_attributes }}>
    <div class="product__tip-description"
         style="background-color: {{ desktop_bg_color }};"
         data-mobile-bg="{{ mobile_bg_color }}"
         data-desktop-bg="{{ desktop_bg_color }}">

      <div class="content-wrapper--left">
        <a href="{{ product_tip_product.url }}" class="product-tip--link">
          <div class="image-wrapper">
            <div class="responsive-image">
              {%- if product_tip_product.featured_media != blank -%}
                <img src="{{ product_tip_product.featured_media | image_url: width: 500 }}"
                     alt="{{ product_tip_product.featured_media.alt | escape }}"
                     loading="lazy"
                     width="500"
                     height="500"
                     class="responsive-image__image product-tip__image">
              {%- endif -%}
            </div>
            <div class="product-tip__image-title">{{ product_tip_product.title }}</div>
          </div>
        </a>
      </div>

      <div class="content-wrapper--right">
        <a href="{{ product_tip_product.url }}" class="product-tip--link">
          <h3 class="tip--title product-tip__desktop_heading">{{ tip_title | default: product_tip_product.title }}</h3>
        </a>

        {%- if tip_description != blank -%}
          <div class="tip-content">{{ tip_description }}</div>
        {%- endif -%}

        <div class="tip-button-wrapper product-tip__button">
          <form method="post"
                action="/cart/add.js"
                id="ProductTipForm-{{ block.id }}"
                accept-charset="UTF-8"
                enctype="multipart/form-data"
                data-product-id="{{ product_tip_product.id }}"
                class="form form--product-tip">
            <input type="hidden" name="form_type" value="product">
            <input type="hidden" name="utf8" value="✓">
            <input type="hidden" name="id" value="{{ product_tip_product.selected_or_first_available_variant.id }}">
            <input type="hidden" name="quantity" value="1">

            <div class="tip-button-wrapper">
              <button type="button"
                      name="add"
                      class="action action--secondary tip-button"
                      data-product-id="{{ product_tip_product.id }}"
                      data-variant-id="{{ product_tip_product.selected_or_first_available_variant.id }}"
                      data-price="{{ product_tip_product.selected_or_first_available_variant.price }}">
                <span>In den Warenkorb - {{ product_tip_product.selected_or_first_available_variant.price | money }}</span>
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script>
  (function() {
    try {
      var form = document.getElementById('ProductTipForm-{{ block.id }}');
      if (!form || form.dataset.bound === 'true') return;
      form.dataset.bound = 'true';
      var button = form.querySelector('.tip-button');
      if (!button) return;
      button.addEventListener('click', async function(event) {
        event.preventDefault();
        event.stopPropagation();
        try {
          var formData = new FormData(form);
          var endpoint = (window.Shopify && window.Shopify.routes && window.Shopify.routes.root) ? (window.Shopify.routes.root + 'cart/add.js') : '/cart/add.js';
          var response = await fetch(endpoint, { method: 'POST', body: formData });
          if (response && response.ok) {
            document.dispatchEvent(new CustomEvent('add-to-cart'));
          }
        } catch (e) {
          // Silently fail
        }
      });
    } catch (e) {}
  })();
  </script>
{%- endif -%}


